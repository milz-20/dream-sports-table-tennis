version: 1
applications:
  - appRoot: web-nextjs
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
        build:
          commands:
            - npm run build
            - cp -r .next/static .next/standalone/.next/
            - cp -r public .next/standalone/
            - |
              cat > .next/standalone/deploy-manifest.json << 'EOF'
              {
                "version": 1,
                "framework": {
                  "name": "next",
                  "version": "14.2.33"
                },
                "imageOptimization": {
                  "path": "/_next/image",
                  "loader": "default"
                },
                "routes": [
                  {
                    "path": "/_next/static/*",
                    "target": "static",
                    "headers": {
                      "cache-control": "public,max-age=31536000,immutable"
                    }
                  },
                  {
                    "path": "/_next/image*",
                    "target": "compute"
                  },
                  {
                    "path": "/*",
                    "target": "compute",
                    "fallback": "index"
                  }
                ]
              }
              EOF
      artifacts:
        baseDirectory: .next/standalone
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    app:
      startCommand: node server.js
    platform: WEB_COMPUTE
